// ArkUIé«˜çº§çŠ¶æ€ç®¡ç†æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•@Stateã€@Propã€@Linkã€@Provideã€@Consumeã€@ObjectLinkç­‰

// æ•°æ®æ¨¡å‹ç±»
@Observed
class User {
  name: string = ''
  age: number = 0
  email: string = ''
  
  constructor(name: string, age: number, email: string) {
    this.name = name
    this.age = age
    this.email = email
  }
}

@Observed
class AppState {
  users: User[] = []
  currentUser: User | null = null
  theme: 'light' | 'dark' = 'light'
  
  addUser(user: User) {
    this.users.push(user)
  }
  
  removeUser(index: number) {
    this.users.splice(index, 1)
  }
}

// ä¸»åº”ç”¨ç»„ä»¶
@Entry
@Component
struct AdvancedStateApp {
  @State appState: AppState = new AppState()
  @Provide('theme') theme: string = 'light'
  @Provide('userCount') userCount: number = 0

  aboutToAppear() {
    // åˆå§‹åŒ–æ•°æ®
    this.appState.addUser(new User('å¼ ä¸‰', 25, 'zhangsan@example.com'))
    this.appState.addUser(new User('æå››', 30, 'lisi@example.com'))
    this.userCount = this.appState.users.length
  }

  build() {
    Column() {
      // ä¸»é¢˜åˆ‡æ¢
      ThemeController({ 
        currentTheme: this.theme,
        onThemeChange: (newTheme: string) => {
          this.theme = newTheme
        }
      })

      // ç”¨æˆ·åˆ—è¡¨
      UserList({ 
        appState: this.appState,
        onUserCountChange: (count: number) => {
          this.userCount = count
        }
      })

      // ç”¨æˆ·ç»Ÿè®¡
      UserStats()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.theme === 'dark' ? Color.Black : Color.White)
  }
}

// ä¸»é¢˜æ§åˆ¶å™¨ç»„ä»¶
@Component
struct ThemeController {
  @Prop currentTheme: string
  onThemeChange: (theme: string) => void = () => {}

  build() {
    Row() {
      Text('ä¸»é¢˜è®¾ç½®')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .flexGrow(1)
      
      Button(this.currentTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸')
        .backgroundColor(Color.Transparent)
        .fontSize(20)
        .onClick(() => {
          const newTheme = this.currentTheme === 'light' ? 'dark' : 'light'
          this.onThemeChange(newTheme)
        })
    }
    .width('100%')
    .padding(15)
    .backgroundColor(this.currentTheme === 'dark' ? '#333' : '#f5f5f5')
  }
}

// ç”¨æˆ·åˆ—è¡¨ç»„ä»¶
@Component
struct UserList {
  @ObjectLink appState: AppState
  onUserCountChange: (count: number) => void = () => {}
  @State @Watch('onNewUserChange') newUserName: string = ''
  @State newUserAge: number = 18
  @State newUserEmail: string = ''

  onNewUserChange() {
    console.log('æ–°ç”¨æˆ·åç§°å˜åŒ–:', this.newUserName)
  }

  private addNewUser() {
    if (this.newUserName.trim() && this.newUserEmail.trim()) {
      const newUser = new User(this.newUserName, this.newUserAge, this.newUserEmail)
      this.appState.addUser(newUser)
      this.onUserCountChange(this.appState.users.length)
      
      // æ¸…ç©ºè¾“å…¥
      this.newUserName = ''
      this.newUserAge = 18
      this.newUserEmail = ''
    }
  }

  @Builder
  userItemBuilder(user: User, index: number) {
    UserItem({ 
      user: user, 
      index: index,
      onDelete: () => {
        this.appState.removeUser(index)
        this.onUserCountChange(this.appState.users.length)
      }
    })
  }

  build() {
    Column() {
      // æ·»åŠ ç”¨æˆ·è¡¨å•
      Column() {
        Text('æ·»åŠ æ–°ç”¨æˆ·')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 10 })

        TextInput({ placeholder: 'å§“å', text: this.newUserName })
          .width('100%')
          .margin({ bottom: 8 })
          .onChange((value: string) => {
            this.newUserName = value
          })

        Row() {
          Text('å¹´é¾„:')
            .fontSize(14)
            .width(50)
          
          Slider({
            value: this.newUserAge,
            min: 1,
            max: 100,
            step: 1
          })
            .flexGrow(1)
            .onChange((value: number) => {
              this.newUserAge = value
            })
          
          Text(`${this.newUserAge}`)
            .fontSize(14)
            .width(40)
            .textAlign(TextAlign.End)
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
        .margin({ bottom: 8 })

        TextInput({ placeholder: 'é‚®ç®±', text: this.newUserEmail })
          .width('100%')
          .margin({ bottom: 10 })
          .onChange((value: string) => {
            this.newUserEmail = value
          })

        Button('æ·»åŠ ç”¨æˆ·')
          .width('100%')
          .backgroundColor(Color.Blue)
          .onClick(() => {
            this.addNewUser()
          })
      }
      .width('100%')
      .padding(15)
      .backgroundColor('#f0f0f0')
      .borderRadius(8)
      .margin({ bottom: 15 })

      // ç”¨æˆ·åˆ—è¡¨
      Text('ç”¨æˆ·åˆ—è¡¨')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 10 })

      List() {
        ForEach(this.appState.users, (user: User, index: number) => {
          ListItem() {
            this.userItemBuilder(user, index)
          }
        }, (user: User, index: number) => `${index}_${user.name}`)
      }
      .width('100%')
      .layoutWeight(1)
    }
    .width('100%')
    .padding(15)
  }
}

// ç”¨æˆ·é¡¹ç»„ä»¶
@Component
struct UserItem {
  @ObjectLink user: User
  @Prop index: number
  onDelete: () => void = () => {}
  @State isEditing: boolean = false
  @State editName: string = ''
  
  aboutToAppear() {
    this.editName = this.user.name
  }

  build() {
    Row() {
      Column() {
        if (this.isEditing) {
          TextInput({ text: this.editName })
            .fontSize(16)
            .flexGrow(1)
            .onChange((value: string) => {
              this.editName = value
            })
            .onSubmit(() => {
              this.user.name = this.editName
              this.isEditing = false
            })
        } else {
          Text(this.user.name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
        }
        
        Text(`å¹´é¾„: ${this.user.age}, é‚®ç®±: ${this.user.email}`)
          .fontSize(12)
          .fontColor(Color.Gray)
          .margin({ top: 2 })
      }
      .flexGrow(1)
      .alignItems(HorizontalAlign.Start)

      Row() {
        Button(this.isEditing ? 'ä¿å­˜' : 'ç¼–è¾‘')
          .fontSize(12)
          .backgroundColor(this.isEditing ? Color.Green : Color.Orange)
          .onClick(() => {
            if (this.isEditing) {
              this.user.name = this.editName
            }
            this.isEditing = !this.isEditing
          })

        Button('åˆ é™¤')
          .fontSize(12)
          .backgroundColor(Color.Red)
          .margin({ left: 8 })
          .onClick(() => {
            this.onDelete()
          })
      }
    }
    .width('100%')
    .padding(10)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin({ bottom: 8 })
    .alignItems(VerticalAlign.Center)
  }
}

// ç”¨æˆ·ç»Ÿè®¡ç»„ä»¶ï¼ˆä½¿ç”¨@Consumeè·å–å…¨å±€çŠ¶æ€ï¼‰
@Component
struct UserStats {
  @Consume('theme') theme: string
  @Consume('userCount') userCount: number

  build() {
    Row() {
      Text('ç”¨æˆ·ç»Ÿè®¡')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .flexGrow(1)
      
      Text(`æ€»è®¡: ${this.userCount} äºº`)
        .fontSize(14)
        .fontColor(this.theme === 'dark' ? Color.White : Color.Black)
    }
    .width('100%')
    .padding(15)
    .backgroundColor(this.theme === 'dark' ? '#444' : '#e0e0e0')
    .borderRadius(8)
    .margin(15)
  }
}