// ArkUIç”Ÿå‘½å‘¨æœŸå’Œè£…é¥°å™¨æµ‹è¯•ç”¨ä¾‹
// æµ‹è¯•å„ç§ç”Ÿå‘½å‘¨æœŸå›è°ƒå’Œé«˜çº§è£…é¥°å™¨

import { router } from '@kit.ArkUI'

// å­˜å‚¨é“¾æ¥è£…é¥°å™¨æµ‹è¯•
class StorageData {
  static readonly THEME_KEY: string = 'app_theme';
  static readonly USER_SETTINGS_KEY: string = 'user_settings';
  static readonly LAST_PAGE_KEY: string = 'last_page';
}

// ç”¨æˆ·è®¾ç½®æ•°æ®æ¨¡å‹
@Observed
class UserSettings {
  username: string = '';
  email: string = '';
  notifications: boolean = true;
  autoSave: boolean = false;
  
  constructor(username: string = '', email: string = '') {
    this.username = username;
    this.email = email;
  }
}

// ä¸»åº”ç”¨å…¥å£ç»„ä»¶
@Entry
@Component
struct LifecycleApp {
  @StorageLink(StorageData.THEME_KEY) appTheme: string = 'light';
  @StorageLink(StorageData.USER_SETTINGS_KEY) userSettings: UserSettings = new UserSettings();
  @StorageLink(StorageData.LAST_PAGE_KEY) lastPage: string = 'home';
  
  aboutToAppear() {
    console.log('LifecycleApp: aboutToAppear - ç»„ä»¶å³å°†å‡ºç°')
    // åˆå§‹åŒ–åº”ç”¨çº§åˆ«çš„æ•°æ®
    this.initializeApp()
  }
  
  aboutToDisappear() {
    console.log('LifecycleApp: aboutToDisappear - ç»„ä»¶å³å°†æ¶ˆå¤±')
    // ä¿å­˜åº”ç”¨çŠ¶æ€
    this.saveAppState()
  }
  
  onPageShow() {
    console.log('LifecycleApp: onPageShow - é¡µé¢æ˜¾ç¤º')
  }
  
  onPageHide() {
    console.log('LifecycleApp: onPageHide - é¡µé¢éšè—')
  }
  
  onBackPress(): boolean {
    console.log('LifecycleApp: onBackPress - è¿”å›æŒ‰é”®å¤„ç†');
    return false; // å…è®¸è¿”å›
  }
  
  private initializeApp() {
    console.log('åˆå§‹åŒ–åº”ç”¨æ•°æ®...')
    // æ¨¡æ‹Ÿä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½æ•°æ®
  }
  
  private saveAppState() {
    console.log('ä¿å­˜åº”ç”¨çŠ¶æ€...')
    // æ¨¡æ‹Ÿä¿å­˜åº”ç”¨çŠ¶æ€åˆ°æŒä¹…åŒ–å­˜å‚¨
  }

  build() {
    Column() {
      // ä¸»é¢˜åˆ‡æ¢æ§åˆ¶
      ThemeSwitcher()
      
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      MainContent({ 
        currentPage: this.lastPage,
        onPageChange: (page: string) => {
          this.lastPage = page
        }
      })
      
      // è®¾ç½®é¢æ¿
      SettingsPanel()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.appTheme === 'dark' ? '#1a1a1a' : '#ffffff')
  }
}

// ä¸»é¢˜åˆ‡æ¢ç»„ä»¶
@Component
struct ThemeSwitcher {
  @StorageLink(StorageData.THEME_KEY) theme: string = 'light';
  @State isAnimating: boolean = false;
  
  aboutToAppear() {
    console.log('ThemeSwitcher: aboutToAppear')
  }
  
  aboutToDisappear() {
    console.log('ThemeSwitcher: aboutToDisappear')
  }

  build() {
    Row() {
      Text('ä¸»é¢˜æ¨¡å¼')
        .fontSize(16)
        .fontColor(this.theme === 'dark' ? Color.White : Color.Black)
        .flexGrow(1)
      
      Button(this.theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸')
        .backgroundColor(Color.Transparent)
        .fontSize(24)
        .rotate({ angle: this.isAnimating ? 180 : 0 })
        .animation({
          duration: 500,
          curve: Curve.EaseInOut
        })
        .onClick(() => {
          this.isAnimating = true
          setTimeout(() => {
            this.theme = this.theme === 'light' ? 'dark' : 'light'
            this.isAnimating = false
          }, 250)
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor(this.theme === 'dark' ? '#2a2a2a' : '#f0f0f0')
    .borderRadius(8)
    .margin(16)
  }
}

// ä¸»è¦å†…å®¹ç»„ä»¶
@Component
struct MainContent {
  @Prop currentPage: string;
  @State @Watch('onPageDataChange') pageData: string = [];
  @State isLoading: boolean = false;
  
  onPageDataChange() {
    console.log('é¡µé¢æ•°æ®å‘ç”Ÿå˜åŒ–:', this.pageData.length)
    // å¯ä»¥åœ¨è¿™é‡Œå¤„ç†æ•°æ®å˜åŒ–çš„å‰¯ä½œç”¨
  }
  
  aboutToAppear() {
    console.log('MainContent: aboutToAppear')
    this.loadPageData()
  }
  
  onDidBuild() {
    console.log('MainContent: onDidBuild - ç»„ä»¶æ„å»ºå®Œæˆ')
  }
  
  private async loadPageData() {
    this.isLoading = true
    console.log(`åŠ è½½é¡µé¢æ•°æ®: ${this.currentPage}`)
    
    // æ¨¡æ‹Ÿå¼‚æ­¥æ•°æ®åŠ è½½
    await new Promise(resolve => setTimeout(resolve, 1000))
    
    this.pageData = [
      `${this.currentPage} - æ•°æ®1`,
      `${this.currentPage} - æ•°æ®2`, 
      `${this.currentPage} - æ•°æ®3`
    ]
    
    this.isLoading = false
  }

  @Builder
  pageContentBuilder() {
    if (this.isLoading) {
      Column() {
        LoadingProgress()
          .width(40)
          .height(40)
          .margin({ bottom: 16 })
        
        Text('åŠ è½½ä¸­...')
          .fontSize(14)
          .fontColor(Color.Gray)
      }
      .width('100%')
      .height(200)
      .justifyContent(FlexAlign.Center)
    } else {
      List() {
        ForEach(this.pageData, (item: string, index: number) => {
          ListItem() {
            DataItem({ data: item, index: index })
          }
        }, (item: string) => item)
      }
      .width('100%')
      .layoutWeight(1)
    }
  }

  build() {
    Column() {
      // é¡µé¢å¯¼èˆª
      Row() {
        ['home', 'profile', 'settings'].forEach((page: string) => {
          Button(page)
            .fontSize(14)
            .backgroundColor(this.currentPage === page ? Color.Blue : Color.Gray)
            .fontColor(Color.White)
            .borderRadius(16)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .margin({ right: 8 })
            .onClick(() => {
              if (this.currentPage !== page) {
                this.onPageChange(page)
                this.loadPageData()
              }
            })
        })
      }
      .width('100%')
      .padding(16)
      .justifyContent(FlexAlign.Start)
      
      // é¡µé¢å†…å®¹
      this.pageContentBuilder()
    }
    .width('100%')
    .layoutWeight(1)
  }
}

// æ•°æ®é¡¹ç»„ä»¶
@Component
struct DataItem {
  @Prop data: string;
  @Prop index: number;
  @State isVisible: boolean = false;
  
  aboutToAppear() {
    console.log(`DataItem ${this.index}: aboutToAppear`)
    // æ·»åŠ å»¶è¿ŸåŠ¨ç”»æ•ˆæœ
    setTimeout(() => {
      this.isVisible = true
    }, this.index * 100)
  }
  
  aboutToDisappear() {
    console.log(`DataItem ${this.index}: aboutToDisappear`)
  }
  
  onVisibleAreaChange(isVisible: boolean, currentRatio: number) {
    console.log(`DataItem ${this.index}: å¯è§æ€§å˜åŒ– - ${isVisible}, æ¯”ä¾‹: ${currentRatio}`)
  }

  build() {
    Row() {
      Text(`${this.index + 1}`)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .width(30)
        .textAlign(TextAlign.Center)
        .backgroundColor(Color.Blue)
        .fontColor(Color.White)
        .borderRadius(15)
        .margin({ right: 12 })
      
      Text(this.data)
        .fontSize(14)
        .flexGrow(1)
        .fontColor(Color.Black)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin({ horizontal: 16, vertical: 4 })
    .opacity(this.isVisible ? 1 : 0)
    .translate({ x: this.isVisible ? 0 : 50 })
    .animation({
      duration: 300,
      curve: Curve.EaseOut
    })
    .onVisibleAreaChange([0.0, 1.0], (isVisible: boolean, currentRatio: number) => {
      this.onVisibleAreaChange(isVisible, currentRatio)
    })
  }
}

// è®¾ç½®é¢æ¿ç»„ä»¶
@Component
struct SettingsPanel {
  @StorageLink(StorageData.USER_SETTINGS_KEY) settings: UserSettings = new UserSettings();
  @LocalStorageLink('panelExpanded') @Watch('onPanelStateChange') isExpanded: boolean = false;
  @State inputUsername: string = '';
  @State inputEmail: string = '';
  
  onPanelStateChange() {
    console.log('è®¾ç½®é¢æ¿çŠ¶æ€å˜åŒ–:', this.isExpanded ? 'å±•å¼€' : 'æ”¶èµ·')
  }
  
  aboutToAppear() {
    console.log('SettingsPanel: aboutToAppear')
    this.inputUsername = this.settings.username
    this.inputEmail = this.settings.email
  }
  
  private saveSettings() {
    this.settings.username = this.inputUsername
    this.settings.email = this.inputEmail
    console.log('è®¾ç½®å·²ä¿å­˜:', this.settings)
  }

  @Builder
  settingFormBuilder() {
    Column() {
      TextInput({ 
        placeholder: 'ç”¨æˆ·å', 
        text: this.inputUsername 
      })
        .width('100%')
        .margin({ bottom: 8 })
        .onChange((value: string) => {
          this.inputUsername = value
        })
      
      TextInput({ 
        placeholder: 'é‚®ç®±', 
        text: this.inputEmail 
      })
        .width('100%')
        .margin({ bottom: 8 })
        .onChange((value: string) => {
          this.inputEmail = value
        })
      
      Row() {
        Text('æ¨é€é€šçŸ¥')
          .fontSize(14)
          .flexGrow(1)
        
        Toggle({ 
          type: ToggleType.Switch, 
          isOn: this.settings.notifications 
        })
          .selectedColor(Color.Blue)
          .onChange((isOn: boolean) => {
            this.settings.notifications = isOn
          })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 8 })
      
      Row() {
        Text('è‡ªåŠ¨ä¿å­˜')
          .fontSize(14)
          .flexGrow(1)
        
        Toggle({ 
          type: ToggleType.Switch, 
          isOn: this.settings.autoSave 
        })
          .selectedColor(Color.Green)
          .onChange((isOn: boolean) => {
            this.settings.autoSave = isOn
          })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 16 })
      
      Button('ä¿å­˜è®¾ç½®')
        .width('100%')
        .backgroundColor(Color.Orange)
        .onClick(() => {
          this.saveSettings()
        })
    }
    .width('100%')
    .padding(16)
  }

  build() {
    Column() {
      // é¢æ¿æ ‡é¢˜
      Row() {
        Text('ç”¨æˆ·è®¾ç½®')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .flexGrow(1)
        
        Button(this.isExpanded ? 'â–²' : 'â–¼')
          .backgroundColor(Color.Transparent)
          .fontSize(12)
          .onClick(() => {
            animateTo({
              duration: 300,
              curve: Curve.EaseInOut
            }, () => {
              this.isExpanded = !this.isExpanded
            })
          })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#e0e0e0')
      .onClick(() => {
        this.isExpanded = !this.isExpanded
      })
      
      // å¯å±•å¼€çš„è®¾ç½®è¡¨å•
      if (this.isExpanded) {
        this.settingFormBuilder()
      }
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(8)
    .margin(16)
    .clipContent()
  }
}